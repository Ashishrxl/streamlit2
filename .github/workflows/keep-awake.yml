name: Keep Streamlit App Awake

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  wake:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Wake up Streamlit app
        run: |
          cat > wakeup.js <<'EOF'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const page = await browser.newPage();
            const url = 'https://csvvisualisation.streamlit.app';
            console.log(`Opening ${url}`);
            await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 60000 });

            // Check for the "wake up" button
            const button = await page.$('text="Yes, get this app back up!"');
            if (button) {
              console.log('App is asleep. Clicking wake-up button...');
              await button.click();
              await page.waitForTimeout(10000);
            } else {
              console.log('App appears to be awake already.');
            }

            console.log('Final check...');
            await page.waitForTimeout(5000);
            console.log(await page.title());
            await browser.close();
          })();
          EOF

          node wakeup.js